<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>音频调试</title>
    <style>
        body { 
            font-family: sans-serif; 
            padding: 20px; 
            background: #0a192f; 
            color: white; 
            margin: 0;
        }
        h1 { 
            background: linear-gradient(135deg, #00dbde 0%, #fc00ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
        }
        .test-panel {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: linear-gradient(135deg, #00dbde 0%, #fc00ff 100%);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
        }
        .success { color: #00b894; }
        .error { color: #ff6b6b; }
    </style>
</head>
<body>
    <div class="test-panel">
        <h1>🎵 音频调试页面</h1>
        <p>测试您的音频文件是否能正常播放：</p>
        
        <button id="testRain">🌧️ 测试雨声</button>
        <button id="testOcean">🌊 测试海风</button>
        <button id="testFocus">🎯 测试专注</button>
        <button id="testSleep">😴 测试睡眠</button>
        
        <button id="testAll" style="background: #00b894; margin-top: 10px;">🧪 测试所有音频</button>
        
        <div class="result" id="result">
            点击按钮开始测试...
        </div>
    </div>
    
    <div class="test-panel">
        <h2>📁 音频文件列表</h2>
        <div id="fileList">正在检查文件...</div>
    </div>
    
    <script>
        // 音频文件列表
        const audioFiles = [
            "fixed_rain.mp3", 
            "fixed_rainnight.mp3", 
            "fixed_seawind.mp3",
            "fixed_attention.mp3", 
            "fixed_sleep_music_master_talk.mp3",
            "fixed_alphameditation.mp3", 
            "fixed_relax_state_meditation.mp3"
        ];

        // 日志函数
        function log(message, type = "info") {
            const resultDiv = document.getElementById("result");
            const time = new Date().toLocaleTimeString();
            const colorClass = type === "success" ? "success" : type === "error" ? "error" : "";
            resultDiv.innerHTML += `<div class="${colorClass}">[${time}] ${message}</div>`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        // 测试单个音频文件
        async function testAudio(filename) {
            log(`开始测试: ${filename}`);
            
            try {
                // 先检查文件是否存在
                const response = await fetch(`/audio/${filename}`);
                if (!response.ok) {
                    throw new Error(`文件不存在 (HTTP ${response.status})`);
                }
                
                // 创建音频对象
                const audio = new Audio(`/audio/${filename}`);
                audio.volume = 0.3; // 降低音量避免吓到
                
                // 设置事件监听器
                audio.addEventListener("canplaythrough", () => {
                    log(`✅ ${filename} 可以播放`, "success");
                });
                
                audio.addEventListener("error", (event) => {
                    const error = event.target.error;
                    log(`❌ ${filename} 错误: ${error ? error.code : "未知错误"}`, "error");
                });
                
                // 尝试播放
                await audio.play();
                log(`▶️ ${filename} 开始播放`, "success");
                
                // 3秒后自动停止
                setTimeout(() => {
                    if (!audio.paused) {
                        audio.pause();
                        log(`⏸️ ${filename} 已停止`);
                    }
                }, 3000);
                
            } catch (error) {
                log(`❌ ${filename} 失败: ${error.message}`, "error");
                console.error("音频测试错误:", error);
            }
        }

        // 测试所有音频
        async function testAllAudios() {
            log("=== 开始测试所有音频 ===");
            
            for (const file of audioFiles) {
                await testAudio(file);
                // 添加延迟避免同时请求过多
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log("=== 所有音频测试完成 ===");
        }

        // 加载文件列表
        function loadFileList() {
            const fileListDiv = document.getElementById("fileList");
            let html = "<ul style='list-style: none; padding: 0;'>";
            
            audioFiles.forEach(file => {
                html += `
                    <li style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                        ${file} 
                        <button onclick="testAudio('${file}')" style="padding: 3px 8px; font-size: 12px; float: right;">测试</button>
                        <div style="clear: both;"></div>
                    </li>
                `;
            });
            
            html += "</ul>";
            fileListDiv.innerHTML = html;
        }

        // 绑定按钮事件（使用事件委托避免绑定问题）
        document.addEventListener("DOMContentLoaded", function() {
            // 绑定按钮点击事件
            document.getElementById("testRain").addEventListener("click", () => testAudio("fixed_rain.mp3"));
            document.getElementById("testOcean").addEventListener("click", () => testAudio("fixed_seawind.mp3"));
            document.getElementById("testFocus").addEventListener("click", () => testAudio("fixed_attention.mp3"));
            document.getElementById("testSleep").addEventListener("click", () => testAudio("fixed_sleep_music_master_talk.mp3"));
            document.getElementById("testAll").addEventListener("click", testAllAudios);
            
            // 加载文件列表
            loadFileList();
            
            log("页面加载完成，可以开始测试");
        });

        // 在全局暴露testAudio函数供行内onclick使用
        window.testAudio = testAudio;
        window.testAllAudios = testAllAudios;
    </script>
</body>
</html>
